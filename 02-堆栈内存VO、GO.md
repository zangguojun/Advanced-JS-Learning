# 堆栈内存VO、GO

### 细节概念

> **栈内存**给了JS**提供了执行环境**，叫**`ECStack` 执行环境栈/执行上下文栈**
>
> + `ECStack`不共用，每打开一个网页都会开辟一个新的`ECStack`
>
> + 除了提供执行环境，还能 存储`基本数据类型`、`变量`和`堆内存的引用地址`
>
> 
>
> **堆内存**是用来**存储属性和方法**，不执行代码，叫**Heap**
>
> + 最初创建的`全局对象`就是在`堆内存`
>
> 
>
> **执行上下文（EC）**：代码执行所在的环境，和**作用域**相似
>
> + JS存在多种执行上下文，每次执行代码，先创建自己的执行上下文
>   + **全局执行上下文（EC(G)）**：当页面关闭，全局上下文会`出ECStack`，并释放
>   + **函数私有执行上下文（EC(FN)）**
>   + **块级执行上下文**
>
> + 在每一个执行上下文都有一个**变量对象（VO）**
>   + 在`当前`上下文中，**用来存放创建的变量和值的地方**
>   + 在`函数私有执行上下文`中叫**活动对象（AO）**，但是也是变量对象，是`VO`的分支
>   + 在`全局执行上下文（EC(G)）`中叫**全局变量对象（VO(G)）**，但是也是变量对象，是`VO`
>
> 
>
> **全局对象（GO）**是把一些`内置的属性和方法`放到一个单独的内存中，叫`堆内存`
>
> + `浏览器`环境下会让`window`指向`GO`，`node`环境下会让`global`指向`GO`
> + 内置的属性和方法，比如，`isNaN`、`parseInt`等
> + `GO`和`VO(G)`的区别和联系
>   + `GO`是全局对象，在堆内存中，存储的是内置的API属性和方法
>   + `VO(G)`是全局变量对象，在全局上下文中用来存储全局变量的空间
>   + 只不过在某些情况下会有一些`VO(G)`与`GO`会有所关联



### 脚本运行时堆栈的使用流程

> 1. 在栈内存中创建`ECStack`，提供JS执行环境
> 2. 在堆内存中创建`GO`，提供内置属性和方法
> 3. 创建`EC(G)`，并且`EC(G)`进`ECStack`
> 4. 代码在`EC(G)`执行
>    + 其中可能涉及到`函数执行上下文、块级执行上下文`等进出`ECStack`
>    + 直到程序结束，`EC(G)`出`ECStack`
> 5. `EC(G)`创建`VO(G)`
> 6. ........
> 7. `EC(G)`出`ECStack`

##### 例子1：

```js
var a = 12;
```

>1. 创建一个值（区别数据类型）
>  + 基本数据类型：直接存储到**栈内存**
>  + 引用数据类型：先开一个**堆内存**，把键值对存储在堆中，**所有的赋值都是指针的关联指向**
>    1. 创建一个**堆内存**
>    2. 如果是对象，就把键值对存储到堆内存中
>    3. 如果是函数，将**形参**存储，把`函数体`当作**字符串**存储，最后还有一些`键值对`
>       + 此时函数体的代码是字符串，无意义，所以不执行，而函数不执行就不会进栈。
>       + 创建函数的时候就已经定义了函数的作用域（也就是创建函数所在的上下文），用`[[scope]]`记录，如在`EC(G)`中创建函数记录为`[[scope]]:EC(G)`
>       + 键值对有：`nam1e`：函数名，`length`：参数个数，`prototype`以及`__proto__`原型
>    4. 堆内存地址放到栈中，供变量调用
>2. 创建一个变量
>3. 让变量和值关联



##### 例子2：

```js
var b['n'] = 12;
```

> `b`基于`地址`找到`堆内存`，然后把`堆内存的属性n`的值改为12



##### 例子3：

```js
var objA = {
  name: 'buchiyu',
  fn: (function (x) {
    return 'hello' + x
  })(objA.name)
}
console.log(objA.fn);
// TypeError: Cannot read property 'name' of undefined
```

> 因为是先创建值，在创建变量，然后才能关联
>
> 为什么不报`obj is not defined`？
>
> + 和变量提升有关

![堆栈内存](https://cdn.jsdelivr.net/gh/zangguojun/PicGo/20210530151408.png)

